#!/usr/bin/env python3
"""Usage:
aws-barman start
aws-barman status
aws-barman stop
aws-barman startup_log
aws-barman ssh
"""

# https://boto3.readthedocs.io/en/latest/reference/services/ec2.html
from os.path import isfile

import boto3
from docopt import docopt

from barman_instance import BarmanInstance
from vault import save_securely, get_private_key

ec2 = boto3.resource('ec2')


def dump_key():
    if not isfile('montagu-barman.pem'):
        print("Writing private key to ./montagu-barman.pem")
        save_securely('montagu-barman.pem', get_private_key())


def ssh(instance: BarmanInstance):
    if instance.exists:
        dump_key()
        suggested_cmd = "ssh -i ./montagu-barman.pem ubuntu@{}".format(
            instance.public_dns_name)
        print("To connect, use:")
        print(suggested_cmd)
    else:
        print("No instance exists")


def status():
    if instance.exists:
        print("Instance status: " + instance.status)
        print("Instance ID: " + instance.id)
        print("Instance DNS: " + instance.public_dns_name)


if __name__ == '__main__':
    args = docopt(__doc__)
    instance = BarmanInstance()
    if args["start"]:
        instance.start()
    elif args["status"]:
        status()
    elif args["stop"]:
        instance.stop()
    elif args["ssh"]:
        ssh(instance)
    elif args["startup_log"]:
        print(instance.get_startup_log())
