#!/usr/bin/env bash
set -eu

echo "*** Pulling montagu-db image to complete restore"
docker pull vimc/montagu-db:master

echo "*** Running postgres on restore volume"
CONTAINER_ID=$(docker run -d --rm \
       -v montagu_db_volume:/pgdata vimc/montagu-db:master \
       /etc/montagu/postgresql.production.conf)
function cleanup {
    set +e
    echo "*** Stopping container!"
    docker stop $CONTAINER_ID
}
trap cleanup EXIT

echo "*** Waiting for process to complete"
docker exec -it $CONTAINER_ID montagu-wait.sh 3600

echo "*** Done!"
docker exec -it $CONTAINER_ID bash -c \
  "date --iso-8601=seconds > /pgdata/.last-restore"
